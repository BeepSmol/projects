<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Time Waster v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* LOW EFFORT UI THEME */
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #050505;
            color: #e0e0e0;
            overflow-x: hidden;
            user-select: none;
        }
        
        body.comic-sans {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif !important;
        }

        /* Brutalist Box Style */
        .box {
            border: 2px solid #ffffff;
            background: #000000;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 4px 4px 0px #333;
        }

        .btn {
            background: #000000;
            border: 2px solid #ffffff;
            color: #ffffff;
            font-weight: bold;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
        }
        .btn:hover:not(:disabled) {
            background: #ffffff;
            color: #000000;
            box-shadow: 2px 2px 0px #888;
        }
        .btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: none;
        }
        .btn:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #000; border-left: 2px solid #fff; }
        ::-webkit-scrollbar-thumb { background: #fff; }

        /* Bouncing Box Canvas */
        #boredomCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0;
        }
        
        .content-layer {
            position: relative;
            z-index: 10;
        }

        /* Hard Mode Overlay */
        #hardModeOverlay {
            pointer-events: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 999;
            opacity: 0;
            background: radial-gradient(circle, transparent 20%, #000 120%);
            backdrop-filter: blur(0px);
            transition: opacity 0.5s;
        }
        .hard-mode-active #hardModeOverlay {
            opacity: 1;
            backdrop-filter: blur(2px) contrast(150%) brightness(60%);
            mix-blend-mode: hard-light;
        }
        .hard-mode-active body {
             text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        /* Golden Second Animation */
        .golden-second {
            position: fixed;
            font-size: 2rem;
            color: #ffd700;
            cursor: pointer;
            user-select: none;
            animation: floatUp 4s linear forwards;
            z-index: 50;
            transition: transform 0.2s, opacity 0.2s;
            text-shadow: 0 0 5px #ffaa00;
        }
        .golden-second.captured {
            color: #00ff00;
            transform: scale(1.5) !important;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff00;
            pointer-events: none;
            animation: none;
            opacity: 1;
        }
        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .modal-content {
            border: 2px solid white;
            background: black;
            padding: 2rem;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 8px 8px 0px #555;
        }

        /* Skill Tree Nodes */
        .skill-node {
            border: 1px dashed #666;
            padding: 10px;
            margin-bottom: 10px;
            opacity: 0.7;
            position: relative;
        }
        .skill-node.unlocked {
            border: 2px solid #00ff00;
            opacity: 1;
            color: #00ff00;
        }

        /* Achievement Toast */
        #achieveToast {
            position: fixed;
            bottom: -100px;
            right: 20px;
            background: #000;
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 15px;
            z-index: 200;
            transition: bottom 0.5s ease-out;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            max-width: 300px;
        }
        
        /* 1 Pixel Button */
        #pixelBtn {
            position: fixed;
            bottom: 0; right: 0;
            width: 2px; height: 2px;
            background: #111;
            cursor: pointer;
            z-index: 9999;
        }
        #pixelBtn:hover { background: red; width: 10px; height: 10px; }

        /* Context Menu */
        #customCtx {
            display: none;
            position: fixed;
            background: #000;
            border: 2px solid white;
            z-index: 10000;
            box-shadow: 4px 4px 0 #555;
            min-width: 150px;
        }
        .ctx-item {
            padding: 8px 16px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            font-size: 12px;
        }
        .ctx-item:hover { background: #fff; color: #000; }

        /* Fake Update */
        #fakeUpdate {
            position: fixed;
            bottom: 20px; right: 20px;
            background: #333;
            border: 1px solid #fff;
            padding: 10px;
            display: none;
            z-index: 500;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        /* Idle Overlay */
        #idleOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Bubble Wrap */
        .bubble {
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 2px solid #555;
            cursor: pointer;
            background: #222;
        }
        .bubble.popped {
            background: transparent;
            border-color: #333;
            transform: scale(0.9);
        }
        .todo-item {
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #333;
            padding: 4px;
            cursor: pointer;
        }
        .todo-item:hover { background: #111; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

  <div id="hardModeOverlay"></div>
  <div id="pixelBtn" title="?"></div>
  
  <div id="customCtx">
      <div class="ctx-item" onclick="ctxAction()">Uninstall Boredom</div>
      <div class="ctx-item" onclick="ctxAction()">Speed Up Time (Paid)</div>
      <div class="ctx-item" onclick="ctxAction()">Free Clocks</div>
  </div>

  <div id="fakeUpdate">
      <div class="font-bold text-sm">âš  System Update Available</div>
      <div class="text-xs">Click to install now...</div>
  </div>

  <div id="idleOverlay">
      <h1 class="text-4xl font-bold mb-4 text-center">ARE YOU STILL WATCHING?</h1>
      <p class="mb-4 text-gray-400">Progression paused due to inactivity.</p>
      <button onclick="resumeIdle()" class="btn">I'M HERE</button>
  </div>

  <div id="startOverlay" class="fixed inset-0 z-[100] bg-black flex items-center justify-center cursor-pointer">
    <div class="text-2xl border-2 border-white p-8 hover:bg-white hover:text-black animate-pulse text-center">
        CLICK TO START WASTING TIME
    </div>
  </div>

  <div id="achieveToast">
      <div class="font-bold text-sm text-yellow-500">ACHIEVEMENT UNLOCKED</div>
      <div id="achieveName" class="text-lg">Title Here</div>
  </div>

    <!-- Assets (handled with fallbacks in JS) -->
    <canvas id="boredomCanvas"></canvas>

    <!-- Desktop Sidebars -->
    <div id="desktopSidebarLeft" class="hidden xl:flex fixed left-4 top-24 bottom-4 w-56 flex-col gap-2 overflow-y-auto z-20 opacity-50 pointer-events-none transition-opacity">
        <div class="text-xs font-bold border-b border-white mb-2 pb-1 text-center">BOREDOM ZONE (L)</div>
    </div>
    <div id="desktopSidebarRight" class="hidden xl:flex fixed right-4 top-24 bottom-4 w-56 flex-col gap-2 overflow-y-auto z-20 opacity-50 pointer-events-none transition-opacity">
        <div class="text-xs font-bold border-b border-white mb-2 pb-1 text-center">BOREDOM ZONE (R)</div>
    </div>

    <div class="content-layer w-full max-w-3xl z-10">
        
        <!-- Header -->
        <header class="text-center mb-8 border-b-2 border-white pb-4">
            <h1 class="text-4xl font-bold uppercase tracking-tighter" id="mainTitle">THE TIME WASTER</h1>
            <div class="flex justify-center gap-2 mt-2">
                <span class="text-xs" id="rankTitle">RANK: NOVICE</span>
            </div>
            
            <div class="flex flex-wrap justify-center gap-2 mt-4">
                <button onclick="toggleMusic()" class="btn text-xs">[TOGGLE MUSIC]</button>
                <button onclick="openModal('settingsModal')" class="btn text-xs border-gray-400 text-gray-400">[SETTINGS]</button>
                <button onclick="openModal('achieveModal')" class="btn text-xs border-yellow-500 text-yellow-500">[HALL OF SHAME]</button>
                <button onclick="triggerReset()" class="btn text-xs hover:bg-red-600 hover:text-white border-red-500 text-red-500">[HARD RESET]</button>
            </div>
            
            <div id="offlineBadge" class="hidden mt-4 border border-green-500 text-green-500 p-2 text-xs">
                OFFLINE PROGRESS: GAINED <span id="offlineGain">0</span> SECONDS
            </div>
        </header>

        <!-- Stats Block -->
        <div class="box flex flex-col items-center">
            
            <!-- TOTALS COUNTERS -->
            <div class="grid grid-cols-2 w-full gap-4 text-center mb-4 border-b border-gray-700 pb-4">
                <div>
                    <div class="text-xs text-purple-400 font-bold lbl-life">LIFETIME</div>
                    <div class="text-xl font-bold text-purple-300" id="chronoTotalDisplay">0.0</div>
                </div>
                <div>
                    <div class="text-xs text-blue-400 font-bold lbl-run">TOTAL (THIS RUN)</div>
                    <div class="text-xl font-bold text-blue-300" id="runTotalDisplay">0.0</div>
                </div>
            </div>

            <!-- MAIN STATS ROW -->
            <div class="grid grid-cols-3 w-full gap-2 text-center mb-6 items-center">
                <div class="col-span-1">
                    <div class="text-xs text-gray-500 lbl-wasted">TIME WASTED</div>
                    <div class="text-3xl font-bold" id="secondsDisplay">0.0</div>
                    <div class="text-xs" id="rateDisplay">+0.0/s</div>
                </div>
                
                <!-- CHRONOTONS -->
                <div id="chronoColumn" class="col-span-1 border-x border-gray-800 hidden">
                    <div class="text-xs text-purple-400">CHRONOTONS</div>
                    <div class="text-3xl font-bold text-purple-400" id="chronotonDisplay">0</div>
                    <div class="text-[10px] text-purple-300" id="chronoMultDisplay">+0% BONUS</div>
                </div>

                <!-- Spacer -->
                <div id="chronoSpacer" class="col-span-1 border-x border-gray-800 flex items-center justify-center">
                    <div class="text-xs text-gray-700">LOCKED</div>
                </div>

                <div class="col-span-1">
                    <div class="text-xs text-gray-500 lbl-clocks">CLOCKS</div>
                    <div class="text-3xl font-bold text-yellow-300" id="clocksDisplay">0</div>
                    <div class="text-xs lbl-curr">CURRENCY</div>
                </div>
            </div>

            <div class="flex gap-2 w-full mb-2">
                <button id="convertBtn" class="btn flex-grow py-4 text-lg border-dashed">
                    CONVERT <span id="convertCost">100</span>s -> 1 CLOCK
                </button>
                <button id="bulkConvertBtn" onclick="bulkConvert()" class="btn w-20 text-xs border-dashed flex flex-col items-center justify-center" title="Convert Max (25% Penalty)">
                    <span>BULK</span>
                    <span class="text-[9px] text-red-400">-25% TAX</span>
                </button>
            </div>
            <div id="convertMsg" class="h-4 text-xs text-red-500 text-center opacity-0">INSUFFICIENT FUNDS</div>
        </div>

        <!-- Prestige Block -->
        <div id="prestigeSection" class="hidden box border-purple-500 text-center">
            <h3 class="text-purple-400 font-bold mb-2">THE CHRONOTON TIME MACHINE</h3>
            <p class="text-xs mb-4">
                The machine hums with energy. Reset your run to acquire Chronotons.
                <br>REQ: <span id="nextChronoReq">25,000</span> LIFETIME SECONDS.
                <br>EFFECT: +100% SPEED PER CHRONOTON.
            </p>
            <div id="potentialChrono" class="text-lg mb-4 text-white">REWARD: 0 CHRONOTONS</div>
            <button onclick="prestige()" class="btn w-full border-purple-500 text-purple-400 hover:bg-purple-900">
                [ACTIVATE TIME MACHINE]
            </button>
        </div>

        <!-- Skill Tree Button -->
        <div id="skillTreeBtnContainer" class="hidden box border-green-500 text-center p-2">
             <button onclick="openModal('skillModal')" class="btn w-full border-green-500 text-green-400">
                [OPEN ANCIENT TABLET]
            </button>
        </div>

        <!-- Layout Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Shop -->
            <div>
                <h2 class="font-bold border-b-2 border-white mb-2" id="shopHeader">SHOP</h2>
                <div id="shopGrid" class="space-y-2">
                    <!-- Shop Items Generated by JS -->
                </div>
            </div>
            <!-- Boredom Zone -->
            <div id="boredomSection" class="opacity-50 pointer-events-none transition-opacity">
                <h2 class="font-bold border-b-2 border-white mb-2 xl:hidden">BOREDOM ZONE</h2>
                <div id="distractionGrid" class="grid grid-cols-2 gap-2 xl:hidden"></div>
                <div id="activeMinigame" class="mt-4 empty:hidden box border-dashed"></div>
            </div>
        </div>

        <!-- Log -->
        <div class="box mt-4 h-32 overflow-y-auto text-xs font-mono text-gray-400 scroll-smooth" id="gameLog">
            <div>> SYSTEM_READY...</div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content border-gray-400">
            <h2 class="text-2xl font-bold text-gray-300 mb-4 border-b border-gray-500 pb-2">SETTINGS</h2>
            <div class="mb-6 space-y-4">
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>SFX VOLUME</span><span id="sfxVal">100%</span></div>
                    <input type="range" id="sfxSlider" min="0" max="1" step="0.1" value="1" oninput="updateSettings()" class="w-full">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>MUSIC VOLUME</span><span id="musicVal">100%</span></div>
                    <input type="range" id="musicSlider" min="0" max="1" step="0.1" value="1" oninput="updateSettings()" class="w-full">
                </div>
            </div>
            <div class="mb-6 border-t border-gray-700 pt-4">
                 <div class="flex justify-between items-center mb-4">
                    <div>
                        <div class="font-bold text-purple-400">LOLCAT MODE</div>
                        <div class="text-[10px] text-gray-400">I CAN HAS CHEEZBURGER?</div>
                    </div>
                    <input type="checkbox" id="lolcatCheck" class="w-6 h-6" onchange="updateSettings()">
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-bold text-red-500">HARD MODE</div>
                        <div class="text-[10px] text-gray-400">Visual distortion. 100x Slower.</div>
                    </div>
                    <input type="checkbox" id="hardModeCheck" class="w-6 h-6" onchange="updateSettings()">
                </div>
            </div>
            <button onclick="closeModal('settingsModal')" class="btn mt-4 w-full">CLOSE</button>
        </div>
    </div>

    <!-- Skill Tree Modal -->
    <div id="skillModal" class="modal">
        <div class="modal-content border-green-500 h-full max-h-screen flex flex-col">
            <h2 class="text-2xl font-bold text-green-400 mb-4 border-b border-green-500 pb-2">ANCIENT TABLET (SKILL TREE)</h2>
            <div class="flex justify-between mb-4 bg-black py-2 border-b border-gray-800 shrink-0">
                <span class="text-green-300">FRAGMENTS: <span id="fragDisplay">0</span></span>
                <button onclick="buyFragment()" class="text-xs border px-2 border-green-500 hover:bg-green-900 transition-colors">100 CLOCKS -> 1 FRAG</button>
            </div>
            <div id="skillList" class="grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto p-1">
                <!-- Injected via JS -->
            </div>
            <button onclick="closeModal('skillModal')" class="btn mt-4 w-full shrink-0">CLOSE</button>
        </div>
    </div>

    <!-- Hall of Shame Modal -->
    <div id="achieveModal" class="modal">
        <div class="modal-content border-yellow-500">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4 border-b border-yellow-500 pb-2">THE HALL OF SHAME</h2>
            <div class="mb-2 text-xs text-right" id="achieveCount">0 / 0</div>
            <div id="achieveList" class="grid grid-cols-1 gap-2 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Injected via JS -->
            </div>
            <button onclick="closeModal('achieveModal')" class="btn mt-4 w-full">CLOSE</button>
        </div>
    </div>

    <script>
        // --- SFX System (Audio Generation) ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctxAudio = new AudioCtx();
        const SFX = {
            play: (type) => {
                const vol = state.settings ? state.settings.sfxVol : 1;
                if (vol <= 0) return;
                
                // Ensure context is running
                if (ctxAudio.state === 'suspended') ctxAudio.resume();

                const osc = ctxAudio.createOscillator();
                const gain = ctxAudio.createGain();
                gain.connect(ctxAudio.destination);
                const now = ctxAudio.currentTime;

                if (type === 'click') {
                    osc.type = 'square'; 
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
                    gain.gain.setValueAtTime(0.1*vol, now); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now+0.1);
                    osc.connect(gain); osc.start(); osc.stop(now+0.1);
                } else if (type === 'convert') {
                    osc.type = 'sawtooth'; 
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(50, now+0.1);
                    gain.gain.setValueAtTime(0.2*vol, now); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now+0.2);
                    osc.connect(gain); osc.start(); osc.stop(now+0.2);
                } else if (type === 'golden') {
                    osc.type = 'sine'; 
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.linearRampToValueAtTime(1500, now+0.3);
                    gain.gain.setValueAtTime(0.1*vol, now); 
                    gain.gain.linearRampToValueAtTime(0, now+0.3);
                    osc.connect(gain); osc.start(); osc.stop(now+0.3);
                } else if (type === 'error') {
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(80, now);
                    gain.gain.setValueAtTime(0.2*vol, now); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now+0.3);
                    osc.connect(gain); osc.start(); osc.stop(now+0.3);
                } else if (type === 'prestige') {
                    osc.type = 'sawtooth'; 
                    osc.frequency.setValueAtTime(50, now);
                    osc.frequency.exponentialRampToValueAtTime(600, now+2);
                    gain.gain.setValueAtTime(0.3*vol, now); 
                    gain.gain.linearRampToValueAtTime(0, now+2);
                    osc.connect(gain); osc.start(); osc.stop(now+2);
                } else if (type === 'ding') {
                    osc.type = 'sine'; 
                    osc.frequency.setValueAtTime(500, now);
                    gain.gain.setValueAtTime(0.1*vol, now); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now+0.5);
                    osc.connect(gain); osc.start(); osc.stop(now+0.5);
                }
            }
        };

        const CONFIG = {
            BASE_CONVERSION: 100,
            CONVERSION_SCALE: 1.01,
            OFFLINE_RATE: 5, 
            CHRONO_THRESHOLD: 25000,
            CHRONO_SCALE: 100, 
            SAVE_KEY: 'timeWaster_v4_fixed'
        };

        // Fallback placeholder for DVD logo
        const assets = { dvd: new Image(), music: null };
        assets.dvd.src = 'dvdlogo.png'; // Will fail if not present, handled in draw loop
        // Music placeholder logic
        let musicPlaying = false;

        let state = {
            seconds: 0, clocks: 0, fragments: 0, chronotons: 0, prestigeCount: 0,
            totalSecondsWasted: 0, runSecondsWasted: 0, conversions: 0,
            lastSaveTime: Date.now(), startTime: Date.now(),
            settings: { sfxVol: 1, musicVol: 1, hardMode: false, lolcat: false, comicSans: false },
            shopCounts: { gears: 0, chrono: 0, machine: 0, dilator: 0, toaster: 0, engine: 0, skill_key: 0 },
            skills: { accel_pulse: false, shiny_magnet: false, eff_expert: false, deep_focus: false, time_warp: false, compound: false, cheap_shop: false, auto_conv: false },
            achievements: [],
            unlocks: { bg: false, dvd: false, chat: false, rock: false, bubble: false, draw: false, unsorter: false, todo: false, waitroom: false, almost: false, dontclick: false, sub_box: false, netflix: false },
            stats: { rockFed: 0, bubblesPopped: 0, bgChanges: 0, fakeClicks: 0, convertSpree: 0, almostFail: 0, chatMsgs: 0, unaffordableTry: 0 },
            timers: { lastInput: Date.now(), sessionStart: Date.now() },
            misc: { subActive: false }
        };

        const SKILLS = [
            { id: 'accel_pulse', name: 'Accelerated Pulse', desc: '+10% Base Time Gen', cost: 1 },
            { id: 'shiny_magnet', name: 'Shiny Magnet', desc: '2x Golden Second Spawn Rate', cost: 2 },
            { id: 'eff_expert', name: 'Efficiency Expert', desc: '-0.5% Conversion Cost Scaling', cost: 3 },
            { id: 'deep_focus', name: 'Deep Focus', desc: '2x Offline Gains', cost: 5 },
            { id: 'time_warp', name: 'Time Warp', desc: '+50% All Production', cost: 10 },
            { id: 'compound', name: 'Compound Interest', desc: '+1% Clocks on Convert', cost: 15 },
            { id: 'cheap_shop', name: 'Coupon Clipper', desc: 'Shop prices -5%', cost: 20 },
            { id: 'auto_conv', name: 'Auto-Converter', desc: 'Auto convert 1% of Secs/s', cost: 50 }
        ];

        const ACHIEVEMENTS = [
            { id: 'anyone', title: "Is anyone there?", desc: "Waste 24 hours total (86400s).", check: (s) => s.totalSecondsWasted >= 86400 },
            { id: 'missed', title: "Missed Opportunity", desc: "Let a Golden Second float away.", manual: true },
            { id: 'collector', title: "Collector of Nothing", desc: "Hold 1,000 Clocks at once.", check: (s) => s.clocks >= 1000 },
            { id: 'pointless', title: "Pointless Endeavor", desc: "Feed the Pet Rock 100 times.", check: (s) => s.stats.rockFed >= 100 },
            { id: 'bubbles', title: "Master of Bubbles", desc: "Pop 1,200 Bubbles total.", check: (s) => s.stats.bubblesPopped >= 1200 },
            { id: 'rebel', title: "The Rebel", desc: "Click the 'Don't Click' button.", manual: true },
            { id: 'traveler', title: "Time Traveler", desc: "Prestige for the first time.", check: (s) => s.prestigeCount >= 1 },
            { id: 'efficient', title: "Efficiency Is Boring", desc: "Buy the Procrastinator's Engine.", check: (s) => s.shopCounts.engine >= 1 },
            { id: 'online', title: "Chronically Online", desc: "Accumulate 1 Week of time wasted.", check: (s) => s.totalSecondsWasted >= 604800 },
            { id: 'productive', title: "Actually Productive", desc: "Close the game for > 48 hours.", manual: true },
            { id: 'speed_demon', title: "Speed Demon", desc: "Convert 10 times in 5 seconds.", manual: true },
            { id: 'indecisive', title: "Indecisive", desc: "Change BG 20 times in 1 minute.", manual: true },
            { id: 'wait_what', title: "Wait, what?", desc: "Find the secret button in Chat.", manual: true },
            { id: 'max_effort', title: "Maximum Effort", desc: "1M Lifetime Secs, 0 Shop items.", check: (s) => s.totalSecondsWasted >= 1000000 && Object.values(s.shopCounts).reduce((a,b)=>a+b,0) === 0 },
            { id: 'the_one_percent', title: "The 1%", desc: "Watch 'Almost Bar' fail.", manual: true },
            { id: 'waiter', title: "Professional Waiter", desc: "Get number called in Waiting Room.", manual: true },
            { id: 'paradox', title: "Paradox", desc: "Prestige with exactly 0 Seconds.", manual: true },
            { id: 'clickbait', title: "Clickbait Victim", desc: "Click Fake Update 5 times.", check: (s) => s.stats.fakeClicks >= 5 },
            { id: 'zen', title: "Zen Master", desc: "No mouse move for 5 mins.", manual: true },
            { id: 'budgeting', title: "Budgeting", desc: "Try to buy item when 1 Clock short.", manual: true },
            { id: 'long_dist', title: "Long Distance", desc: "DVD logo hit 4 corners.", manual: true },
            { id: 'heist', title: "Time Heist", desc: "Capture 5 Golden Seconds in 1 min.", manual: true },
            { id: 'completionist', title: "The Completionist", desc: "Unlock all Boredom items.", check: (s) => Object.values(s.unlocks).every(u => u) },
            { id: 'regret', title: "Infinite Regret", desc: "Reset save after reaching highest rank.", manual: true },
            { id: 'persistence', title: "Persistence", desc: "Try buy unaffordable 50 times.", check: (s) => s.stats.unaffordableTry >= 50 },
            { id: 'anticlimax', title: "Anti-Climactic", desc: "Reach 99% on Almost Bar 5 times.", check: (s) => s.stats.almostFail >= 5 },
            { id: 'speed_reader', title: "Speed Reader", desc: "100 Chat messages generated.", check: (s) => s.stats.chatMsgs >= 100 },
            { id: 'overachiever', title: "Overachiever", desc: "1000x Multiplier.", check: (s) => (1 + s.chronotons * 100) >= 1000 },
            { id: 'did_i', title: "Did I do that?", desc: "Click Golden Second while busy.", manual: true },
            { id: 'worse', title: "It gets worse from here", desc: "Turn on Hard Mode.", manual: true },
            { id: 'font', title: "Forbidden Font", desc: "Activate Comic Sans mode.", manual: true },
            { id: 'beat', title: "Beat the Game?", desc: "Have everything.", check: (s) => checkBeatGame(s) }
        ];

        const RANKS = [
            { t: 0, title: "NOVICE" }, { t: 60, title: "WASTER" }, { t: 300, title: "IDLER" },
            { t: 1000, title: "SLACKER" }, { t: 3600, title: "PROCRASTINATOR" },
            { t: 10000, title: "DAYDREAMER" }, { t: 25000, title: "CHRONO-SCOUT" },
            { t: 50000, title: "CLOCK WATCHER" }, { t: 86400, title: "TIME BANDIT" },
            { t: 250000, title: "EPOCH EATER" }, { t: 500000, title: "ERA ERASER" },
            { t: 1000000, title: "ENTROPY GOD" }, { t: 10000000, title: "TIME LORD" },
            { t: 100000000, title: "ETERNAL VOID" }
        ];

        const SHOP = [
            { id: 'gears', name: 'RUSTY GEARS', desc: '+0.5 sec/s', cost: 1, power: 0.5 },
            { id: 'chrono', name: 'DIGITAL WATCH', desc: '+2.0 sec/s', cost: 10, power: 2.0 },
            { id: 'machine', name: 'FLUX CAPACITOR', desc: '+10.0 sec/s', cost: 50, power: 10.0 },
            { id: 'dilator', name: 'TIME DILATOR', desc: '+50.0 sec/s', cost: 200, power: 50.0 },
            { id: 'toaster', name: 'QUANTUM TOASTER', desc: '+250.0 sec/s', cost: 1000, power: 250.0 },
            { id: 'skill_key', name: 'ANCIENT TABLET', desc: 'Unlock Skill Tree', cost: 500, power: 0, special: true },
            { id: 'engine', name: 'PROCRASTINATOR ENGINE', desc: 'Auto-collect Golden Seconds (50%)', cost: 500, power: 0, special: true } 
        ];

        const DISTRACTIONS = [
            { id: 'bg', name: 'COLOR_SHIFT', desc: 'Change Bg', cost: 1, curr: 'c', action: () => changeBg() },
            { id: 'rock', name: 'PET_ROCK', desc: 'Feed Clocks', cost: 5, curr: 'c', action: () => renderRock() },
            { id: 'dvd', name: 'DVD_SCREEN', desc: 'Bouncing Logo', cost: 10, curr: 'c', action: () => toggleDVD() },
            { id: 'chat', name: 'LIVESTREAM', desc: 'Read Spam', cost: 20, curr: 'c', action: () => renderChat() },
            { id: 'bubble', name: 'BUBBLE WRAP', desc: 'Pop pop pop', cost: 40, curr: 'c', action: () => renderBubble() },
            { id: 'draw', name: 'DRAWING PAD', desc: 'Useless Art', cost: 100, curr: 'c', action: () => renderDraw() },
            { id: 'unsorter', name: 'THE UN-SORTER', desc: 'Sort pixels', cost: 75, curr: 'c', action: () => renderUnsorter() },
            { id: 'todo', name: 'INF. TO-DO', desc: 'Never ending', cost: 150, curr: 'c', action: () => renderTodo() },
            { id: 'waitroom', name: 'WAITING ROOM', desc: 'Get in line', cost: 200, curr: 'c', action: () => renderWaiting() },
            { id: 'almost', name: 'ALMOST BAR', desc: '99% Loading', cost: 300, curr: 'c', action: () => renderAlmost() },
            { id: 'sub_box', name: 'SUB BOX', desc: 'Mystery Gifts', cost: 10, curr: 'c', action: () => toggleSubBox() },
            { id: 'netflix', name: 'NETFLIX BLOCKER', desc: 'No Idle Pause', cost: 10, curr: 'k', action: () => activateNetflix() },
            { id: 'dontclick', name: 'DO NOT CLICK', desc: 'Seriously', cost: 666, curr: 'c', action: () => renderDontClick() }
        ];

        // --- DOM ---
        const els = {
            sec: document.getElementById('secondsDisplay'),
            clk: document.getElementById('clocksDisplay'),
            rate: document.getElementById('rateDisplay'),
            btnConv: document.getElementById('convertBtn'),
            costConv: document.getElementById('convertCost'),
            msgConv: document.getElementById('convertMsg'),
            shop: document.getElementById('shopGrid'),
            dist: document.getElementById('distractionGrid'),
            deskLeft: document.getElementById('desktopSidebarLeft'),
            deskRight: document.getElementById('desktopSidebarRight'),
            log: document.getElementById('gameLog'),
            zone: document.getElementById('boredomSection'),
            mini: document.getElementById('activeMinigame'),
            cvs: document.getElementById('boredomCanvas'),
            prestige: document.getElementById('prestigeSection'),
            chrono: document.getElementById('chronotonDisplay'),
            chronoCol: document.getElementById('chronoColumn'),
            chronoSpc: document.getElementById('chronoSpacer'),
            chronoMult: document.getElementById('chronoMultDisplay'),
            potChrono: document.getElementById('potentialChrono'),
            offline: document.getElementById('offlineBadge'),
            chronoTotal: document.getElementById('chronoTotalDisplay'),
            runTotal: document.getElementById('runTotalDisplay'),
            skillBtn: document.getElementById('skillTreeBtnContainer'),
            frag: document.getElementById('fragDisplay')
        };

        // --- Loop ---
        let lastTime = Date.now();
        let saveTimer = 0;
        let goldenTimer = 0;
        let dingTimer = 0;
        let fakeUpdTimer = 0;
        let subTimer = 0;
        let autoConvTimer = 0;
        let shopGenerated = false;
        
        // Trackers
        let convertClicks = [];
        let bgClicks = [];
        let goldenSpree = [];

        function gameLoop() {
            const now = Date.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;

            // Idle Check
            if (now - state.timers.lastInput > 600000 && !state.unlocks.netflix) { // 10 mins
                document.getElementById('idleOverlay').style.display = 'flex';
                requestAnimationFrame(gameLoop);
                return; // Pause logic
            }

            // Calc Rate
            let baseRate = 1;
            if(state.skills.accel_pulse) baseRate *= 1.10;
            SHOP.forEach(item => { baseRate += (state.shopCounts[item.id] || 0) * item.power; });
            if(state.skills.time_warp) baseRate *= 1.5;
            
            const prestigeMult = 1 + (state.chronotons * 100); 
            const realWorldMult = getRealWorldMult();
            let finalRate = baseRate * prestigeMult * realWorldMult;

            if (state.settings.hardMode) finalRate *= 0.01;

            const gain = finalRate * dt;
            state.seconds += gain;
            state.totalSecondsWasted += gain;
            state.runSecondsWasted += gain;

            // Auto Convert Skill
            if (state.skills.auto_conv) {
                autoConvTimer += dt;
                if (autoConvTimer >= 1) {
                    const cost = getConversionCost();
                    if (state.seconds >= cost) {
                        state.seconds -= cost;
                        state.clocks++;
                        state.conversions++;
                    }
                    autoConvTimer = 0;
                }
            }

            // Random Ding
            dingTimer += dt;
            if (dingTimer > (600 + Math.random()*600)) { // 10-20 mins
                SFX.play('ding');
                const toast = document.getElementById('achieveToast');
                document.getElementById('achieveName').innerText = "Nothing happened. Just checking.";
                toast.style.bottom = "20px";
                setTimeout(() => { toast.style.bottom = "-100px"; }, 3000);
                dingTimer = 0;
            }

            // Fake Update
            fakeUpdTimer += dt;
            if (fakeUpdTimer > 60) {
                if (Math.random() < 0.05) {
                    document.getElementById('fakeUpdate').style.display = 'block';
                }
                fakeUpdTimer = 0;
            }

            // Sub Box
            if (state.unlocks.sub_box) {
                subTimer += dt;
                if (subTimer > 600) { // 10 mins
                    if (state.clocks >= 10) {
                        state.clocks -= 10;
                        log("SUBSCRIPTION GIFT: You feel satisfaction!");
                        SFX.play('golden');
                    }
                    subTimer = 0;
                }
            }

            // Updates
            updateUI(finalRate, prestigeMult);
            checkAchievements();
            
            // Autosave (10s)
            saveTimer += dt;
            if (saveTimer > 10) { saveGame(); saveTimer = 0; }

            // Golden Seconds
            goldenTimer += dt;
            const spawnChance = state.skills.shiny_magnet ? 0.04 : 0.02;
            if (goldenTimer > 1) { 
                if (Math.random() < spawnChance) spawnGoldenSecond(); 
                goldenTimer = 0;
            }

            // Zen Master Check
            if (now - state.timers.lastInput > 300000) unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='zen'));

            requestAnimationFrame(gameLoop);
        }

        // --- Logic ---
        function getRealWorldMult() {
            const h = new Date().getHours();
            return (h >= 1 && h < 4) ? 2.0 : 1.0;
        }

        function getConversionCost() {
            const prestigePenalty = Math.pow(10, state.prestigeCount);
            let scale = CONFIG.CONVERSION_SCALE;
            if(state.skills.eff_expert) scale -= 0.005;
            return Math.floor((CONFIG.BASE_CONVERSION * prestigePenalty) * Math.pow(scale, state.conversions));
        }

        function getNextChronoCost() {
            return CONFIG.CHRONO_THRESHOLD * Math.pow(CONFIG.CHRONO_SCALE, state.chronotons);
        }

        function checkBeatGame(s) {
            const allShop = SHOP.every(i => s.shopCounts[i.id] > 0);
            const allDist = DISTRACTIONS.every(d => s.unlocks[d.id]);
            const allAch = ACHIEVEMENTS.filter(a => a.id !== 'beat').every(a => s.achievements.includes(a.id));
            return allShop && allDist && s.chronotons >= 5 && allAch;
        }

        // --- UI ---
        function updateUI(rate, pMult) {
            const lol = state.settings.lolcat;
            
            els.sec.innerText = formatNum(state.seconds);
            els.clk.innerText = formatNum(state.clocks);
            els.rate.innerText = `+${formatNum(rate)}/s`;
            els.chronoTotal.innerText = formatNum(state.totalSecondsWasted);
            els.runTotal.innerText = formatNum(state.runSecondsWasted);
            els.chrono.innerText = formatNum(state.chronotons);
            els.chronoMult.innerText = `+${formatNum((pMult - 1) * 100)}% BONUS`;
            els.frag.innerText = state.fragments;

            // Static Labels Lolcat
            if(lol) {
                document.getElementById('mainTitle').innerText = "TEH TIEM WASTUR";
                document.getElementById('rankTitle').innerText = `RANK: ${lolcat(getRankTitle())}`;
                document.querySelector('.lbl-life').innerText = "LIEFTIEM";
                document.querySelector('.lbl-run').innerText = "TOTUL (DIS RUN)";
                document.querySelector('.lbl-wasted').innerText = "TIEM WASTD";
                document.querySelector('.lbl-clocks').innerText = "CLOKS";
                document.querySelector('.lbl-curr').innerText = "CURRENCZ";
                document.getElementById('shopHeader').innerText = "SHOPPE";
            } else {
                document.getElementById('mainTitle').innerText = "THE TIME WASTER";
                document.getElementById('rankTitle').innerText = `RANK: ${getRankTitle()}`;
                document.querySelector('.lbl-life').innerText = "LIFETIME";
                document.querySelector('.lbl-run').innerText = "TOTAL (THIS RUN)";
                document.querySelector('.lbl-wasted').innerText = "TIME WASTED";
                document.querySelector('.lbl-clocks').innerText = "CLOCKS";
                document.querySelector('.lbl-curr').innerText = "CURRENCY";
                document.getElementById('shopHeader').innerText = "SHOP";
            }

            if (state.prestigeCount > 0) {
                els.chronoCol.classList.remove('hidden'); els.chronoSpc.classList.add('hidden');
            }
            if (state.shopCounts.skill_key > 0) els.skillBtn.classList.remove('hidden');
            else els.skillBtn.classList.add('hidden');

            const cost = getConversionCost();
            els.costConv.innerText = formatNum(cost);
            els.btnConv.disabled = state.seconds < cost;

            if (state.clocks > 0 || state.totalSecondsWasted > 50) {
                els.zone.classList.remove('opacity-50', 'pointer-events-none');
                els.deskLeft.classList.remove('opacity-50', 'pointer-events-none');
                els.deskRight.classList.remove('opacity-50', 'pointer-events-none');
            }

            const nextCost = getNextChronoCost();
            const canPrestige = state.totalSecondsWasted >= nextCost;
            document.getElementById('nextChronoReq').innerText = formatNum(nextCost);
            if (canPrestige) {
                els.prestige.classList.remove('hidden');
                els.potChrono.innerText = `REWARD: 1 CHRONOTON`;
            } else { els.prestige.classList.add('hidden'); }

            renderShopUI();
            renderDistractionsUI();
        }

        function getRankTitle() {
            const rank = RANKS.findLast(r => state.totalSecondsWasted >= r.t) || RANKS[0];
            return rank.title;
        }

        function renderShopUI() {
            const lol = state.settings.lolcat;
            const grid = document.getElementById('shopGrid');

            // Generate items if missing or force refresh for lolcat toggle
            if (!shopGenerated || grid.children.length !== SHOP.length) {
                grid.innerHTML = '';
                SHOP.forEach(item => {
                    const div = document.createElement('div');
                    div.id = `shop-div-${item.id}`;
                    div.className = "flex justify-between items-center box p-2 bg-gray-900";
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-sm" id="title-${item.id}">${item.name}</div>
                            <div class="text-[10px] text-gray-400" id="desc-${item.id}">${item.desc}</div>
                            <div class="text-[10px] text-blue-400">OWNED: <span id="count-${item.id}">0</span></div>
                        </div>
                        <button id="btn-${item.id}" onclick="buy('${item.id}')" class="btn text-xs w-24 border-gray-500">
                            BUY: <span class="price">0</span>
                        </button>
                    `;
                    grid.appendChild(div);
                });
                shopGenerated = true;
            }

            // Update items
            SHOP.forEach(item => {
                const btn = document.getElementById(`btn-${item.id}`);
                const title = document.getElementById(`title-${item.id}`);
                const desc = document.getElementById(`desc-${item.id}`);
                const countEl = document.getElementById(`count-${item.id}`);

                // Mystery Logic for Ancient Tablet
                let displayName = item.name;
                let displayDesc = item.desc;
                
                if (item.id === 'skill_key' && state.chronotons < 1) {
                     displayName = "???";
                     displayDesc = "???";
                }

                if(title) title.innerText = lol ? lolcat(displayName) : displayName;
                if(desc) desc.innerText = lol ? lolcat(displayDesc) : displayDesc;
                if(countEl) countEl.innerText = state.shopCounts[item.id] || 0;

                if (item.special && state.shopCounts[item.id] > 0) {
                    btn.disabled = true;
                    btn.innerHTML = `OWNED`;
                    btn.classList.add('opacity-50');
                } else {
                    const count = state.shopCounts[item.id] || 0;
                    let price = item.cost + (count * item.cost);
                    if(state.skills.cheap_shop) price = Math.floor(price * 0.95);
                    
                    btn.disabled = state.clocks < price;
                    btn.innerHTML = `BUY: <span class="price">${formatNum(price)}</span>`;
                }
            });
        }

        function renderDistractionsUI() {
            const lol = state.settings.lolcat;
            // Generate distractions handled by renderDistractions(), here we update visuals
            DISTRACTIONS.forEach(d => {
                const unlocked = state.unlocks[d.id];
                const btnMob = document.getElementById(`dist-btn-${d.id}-mob`);
                const btnDesk = document.getElementById(`dist-btn-${d.id}-desk`);

                // Ensure labels match lolcat mode
                const name = lol ? lolcat(d.name) : d.name;
                const desc = lol ? lolcat(d.desc) : d.desc;
                const costLabel = lol ? "BUY" : "BUY";
                const launchLabel = lol ? "LAUNCH" : "LAUNCH";
                
                const updateCard = (el) => {
                    if(!el) return;
                    if (unlocked) {
                        el.querySelector('.dist-name').innerText = name;
                        el.querySelector('.dist-desc').innerText = desc;
                        el.querySelector('button').innerText = launchLabel;
                    } else {
                         el.querySelector('.dist-name').innerText = "LOCKED";
                         el.querySelector('.dist-desc').innerText = name;
                         const costTxt = d.curr === 'k' ? `${d.cost} CHRONO` : `${d.cost} CLOCKS`;
                         el.querySelector('button').innerText = `${costLabel}: ${costTxt}`;
                    }
                };
                
                updateCard(btnMob);
                updateCard(btnDesk);
                
                if (!unlocked) {
                    const canAfford = d.curr === 'k' ? state.chronotons >= d.cost : state.clocks >= d.cost;
                    [btnMob, btnDesk].forEach(b => {
                        if(b) {
                            const btn = b.querySelector('button');
                            btn.style.borderColor = canAfford ? '#ffffff' : '#555555';
                            btn.style.color = canAfford ? '#ffffff' : '#555555';
                            btn.disabled = !canAfford;
                        }
                    });
                }
            });
        }

        // --- Formatting ---
        function formatNum(num) {
            if (num < 1000) return Math.floor(num * 10) / 10;
            const suffixes = ["", "k", "M", "B", "T", "Qa", "Qi", "Sx"];
            const suffixNum = Math.floor(Math.log10(num) / 3);
            if (suffixNum === 0) return Math.floor(num * 10) / 10; 
            if (suffixNum >= suffixes.length) return num.toExponential(2);
            return (num / Math.pow(1000, suffixNum)).toFixed(2) + suffixes[suffixNum];
        }

        function lolcat(text) {
            if (!text) return "";
            return text.toUpperCase()
                       .replace(/YOU/g, "U").replace(/THE/g, "TEH").replace(/TIME/g, "TIEM")
                       .replace(/CLOCKS/g, "CLOKS").replace(/SECONDS/g, "SECUNDS")
                       .replace(/ARE/g, "R").replace(/PLEASE/g, "PLZ").replace(/ZONE/g, "ZOAN")
                       .replace(/SHOP/g, "SHOPPE").replace(/UNLOCK/g, "UNLOK")
                       .replace(/WHAT/g, "WUT").replace(/WAIT/g, "WAET")
                       .replace(/UPDATE/g, "UPDAET").replace(/MYSTERY/g, "MISTERY")
                       .replace(/GIFT/g, "GIFTZ").replace(/SATISFACTION/g, "HAPPINESS");
        }

        // --- Actions ---

        window.convert = function() {
            const cost = getConversionCost();
            if (state.seconds >= cost) {
                state.seconds -= cost;
                
                let gain = 1;
                if(state.skills.compound) gain = 1.01; 
                state.clocks += gain;
                
                state.conversions++;
                SFX.play('convert');
                
                // Achievement: Speed Demon
                const now = Date.now();
                convertClicks.push(now);
                convertClicks = convertClicks.filter(t => now - t < 5000);
                if(convertClicks.length >= 10) unlockAchievement(ACHIEVEMENTS.find(a => a.id === 'speed_demon'));
                
                state.stats.convertSpree = convertClicks.length;
                updateUI(0, 1 + state.chronotons*100);
            } else {
                SFX.play('error');
                els.msgConv.style.opacity = 1;
                setTimeout(() => els.msgConv.style.opacity = 0, 1000);
            }
        };
        els.btnConv.onclick = window.convert;

        window.bulkConvert = function() {
            // Robust bulk convert logic with math
            const prestigePenalty = Math.pow(10, state.prestigeCount);
            let scale = CONFIG.CONVERSION_SCALE;
            if(state.skills.eff_expert) scale -= 0.005;
            
            const currentCost = getConversionCost();

            if (state.seconds < currentCost) {
                SFX.play('error');
                return;
            }

            // Calculate max affordable 'n' items where: Cost(n) = Base * Scale^(n+current_conversions)
            // Simplified: Just loop up to 500 times. Math.log is precise but floating point errors in incremental games can be tricky.
            // Loop is safe for this scale.
            
            let bought = 0;
            // Cap to prevent freeze, but 500 is instant in modern JS
            for(let i=0; i<250; i++) {
                const c = Math.floor((CONFIG.BASE_CONVERSION * prestigePenalty) * Math.pow(scale, state.conversions + bought));
                if (state.seconds >= c) {
                    state.seconds -= c;
                    bought++;
                } else {
                    break;
                }
            }

            if (bought > 0) {
                // Apply 25% tax (penalty)
                // "converts 25% less than it would if you convert all the seconds normally"
                // Means we spent seconds for N conversions, but only gain N * 0.75 clocks.
                const taxedGain = Math.floor(bought * 0.75);
                
                // Need to increment conversions count by the full 'bought' amount so price scales correctly
                state.conversions += bought;
                state.clocks += taxedGain;

                SFX.play('convert');
                log(`BULK: SPENT FOR ${bought}, GAINED ${taxedGain} (TAXED).`);
                updateUI(0, 1 + state.chronotons*100);
            }
        }

        window.buy = function(id) {
            const item = SHOP.find(i => i.id === id);
            const count = state.shopCounts[id] || 0;
            let price = item.cost + (count * item.cost);
            if(state.skills.cheap_shop) price = Math.floor(price * 0.95);

            // Budgeting Achievement
            if (price - state.clocks === 1) unlockAchievement(ACHIEVEMENTS.find(a => a.id === 'budgeting'));
            
            // Persistence Achievement
            if (state.clocks < price) {
                state.stats.unaffordableTry = (state.stats.unaffordableTry || 0) + 1;
                SFX.play('error');
            }

            if (state.clocks >= price) {
                state.clocks -= price;
                state.shopCounts[id] = count + 1;
                SFX.play('click');
                log(`BOUGHT ${item.name}`);
                saveGame();
                updateUI(0, 1 + state.chronotons*100);
            }
        };

        window.buyDist = function(id) {
            const d = DISTRACTIONS.find(x => x.id === id);
            let success = false;
            if (d.curr === 'k') {
                if (state.chronotons >= d.cost) { state.chronotons -= d.cost; success = true; }
            } else {
                if (state.clocks >= d.cost) { state.clocks -= d.cost; success = true; }
            }
            if (success) {
                state.unlocks[id] = true;
                SFX.play('click');
                saveGame();
                renderDistractions(); // Rebuilds grid to show LAUNCH button
            } else { SFX.play('error'); }
        };

        window.triggerReset = function() {
            if (confirm("HARD RESET? This will wipe EVERYTHING.")) {
                if (confirm("REALLY? There is no going back.")) {
                    const rankIdx = RANKS.findIndex(r => state.totalSecondsWasted >= r.t);
                    if(rankIdx >= RANKS.length - 2) {
                        alert("ACHIEVEMENT UNLOCKED: INFINITE REGRET. Goodbye.");
                    }
                    localStorage.removeItem(CONFIG.SAVE_KEY);
                    location.reload();
                }
            }
        };

        window.prestige = function() {
            if (Math.floor(state.seconds) === 0) unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='paradox'));

            const cost = getNextChronoCost();
            if (state.totalSecondsWasted < cost) return;
            if (!confirm(`RESET RUN? You will lose all items and time, but keep Achievements and get Chronotons.`)) return;
            
            SFX.play('prestige');
            state.chronotons += 1;
            state.prestigeCount++;
            state.seconds = 0;
            state.runSecondsWasted = 0; 
            state.clocks = 0;
            state.conversions = 0;
            state.shopCounts = { gears: 0, chrono: 0, machine: 0, dilator: 0, toaster: 0, engine: 0, skill_key: 0 };
            // Keep fragments and skills? Usually yes in prestige.
            
            saveGame();
            location.reload(); // Safer to reload to reset rates
        };

        // --- Fake Update ---
        document.getElementById('fakeUpdate').onclick = function() {
            this.style.display = 'none';
            state.seconds = state.seconds / 100;
            state.stats.fakeClicks = (state.stats.fakeClicks || 0) + 1;
            SFX.play('error');
            log("FAKE UPDATE INSTALLED. TIME DIVIDED BY 100.");
            unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='clickbait'));
        }

        // --- Pixel Button ---
        document.getElementById('pixelBtn').onclick = function() {
            document.body.classList.add('comic-sans');
            state.settings.comicSans = true;
            unlockAchievement(ACHIEVEMENTS.find(a => a.id === 'font'));
            saveGame();
        }

        // --- Context Menu ---
        window.oncontextmenu = function(e) {
            e.preventDefault();
            const ctx = document.getElementById('customCtx');
            ctx.style.display = 'block';
            ctx.style.left = e.clientX + 'px';
            ctx.style.top = e.clientY + 'px';
        }
        window.onclick = function(e) {
            if (!e.target.closest('.ctx-item')) {
                document.getElementById('customCtx').style.display = 'none';
            }
            state.timers.lastInput = Date.now();
        }
        window.ctxAction = function() {
            alert("This feature will be available in the year 600000.");
        }

        window.resumeIdle = function() {
            document.getElementById('idleOverlay').style.display = 'none';
            state.timers.lastInput = Date.now();
        }

        // --- Modal & Skill Logic ---
        
        window.openModal = function(id) {
            document.getElementById(id).classList.add('active');
            if(id === 'skillModal') renderSkills();
            if(id === 'achieveModal') renderAchievements();
            if(id === 'settingsModal') {
                document.getElementById('sfxSlider').value = state.settings.sfxVol;
                document.getElementById('musicSlider').value = state.settings.musicVol;
                document.getElementById('hardModeCheck').checked = state.settings.hardMode;
                document.getElementById('lolcatCheck').checked = state.settings.lolcat;
            }
            SFX.play('click');
        }
        window.closeModal = function(id) {
            document.getElementById(id).classList.remove('active');
            SFX.play('click');
        }

        window.updateSettings = function() {
            state.settings.sfxVol = parseFloat(document.getElementById('sfxSlider').value);
            state.settings.musicVol = parseFloat(document.getElementById('musicSlider').value);
            const hard = document.getElementById('hardModeCheck').checked;
            const lol = document.getElementById('lolcatCheck').checked;
            
            if (hard && !state.settings.hardMode) unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='worse'));
            state.settings.hardMode = hard;
            state.settings.lolcat = lol;

            document.getElementById('sfxVal').innerText = Math.round(state.settings.sfxVol * 100) + "%";
            document.getElementById('musicVal').innerText = Math.round(state.settings.musicVol * 100) + "%";
            // Music placeholder hook
            // if(assets.music) assets.music.volume = state.settings.musicVol;
            
            if (hard) document.body.classList.add('hard-mode-active');
            else document.body.classList.remove('hard-mode-active');
            
            // Force re-render of text
            shopGenerated = false; // force rebuild shop
            updateUI(0, 1 + state.chronotons*100);
        }

        function renderSkills() {
            const list = document.getElementById('skillList');
            list.innerHTML = '';
            SKILLS.forEach(s => {
                const owned = state.skills[s.id];
                const div = document.createElement('div');
                div.className = `skill-node ${owned ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="font-bold">${s.name}</div>
                    <div class="text-xs text-gray-400 mb-2">${s.desc}</div>
                    ${owned ? '<span class="text-green-500 font-bold">UNLOCKED</span>' : 
                      `<button onclick="unlockSkill('${s.id}')" class="btn text-xs border-green-500 text-green-500 w-full">UNLOCK (${s.cost} FRAG)</button>`}
                `;
                list.appendChild(div);
            });
        }

        window.buyFragment = function() {
            if (state.clocks >= 100) {
                state.clocks -= 100; state.fragments++;
                SFX.play('convert'); els.frag.innerText = state.fragments;
            } else { SFX.play('error'); }
        }

        window.unlockSkill = function(id) {
            const skill = SKILLS.find(x => x.id === id);
            if (state.fragments >= skill.cost) {
                state.fragments -= skill.cost; state.skills[id] = true;
                SFX.play('golden'); renderSkills(); saveGame();
            } else { SFX.play('error'); }
        }

        function renderAchievements() {
            const list = document.getElementById('achieveList');
            list.innerHTML = '';
            let count = 0;
            ACHIEVEMENTS.forEach(a => {
                const unlocked = state.achievements.includes(a.id);
                if(unlocked) count++;
                const div = document.createElement('div');
                div.className = `p-2 border ${unlocked ? 'border-yellow-400 text-yellow-400' : 'border-gray-800 text-gray-800'}`;
                div.innerHTML = `<div class="font-bold text-sm">${a.title}</div><div class="text-xs">${unlocked ? a.desc : 'LOCKED'}</div>`;
                list.appendChild(div);
            });
            document.getElementById('achieveCount').innerText = `${count} / ${ACHIEVEMENTS.length}`;
        }

        function unlockAchievement(a) {
            if (!a || state.achievements.includes(a.id)) return;
            state.achievements.push(a.id);
            const toast = document.getElementById('achieveToast');
            document.getElementById('achieveName').innerText = a.title;
            toast.style.bottom = "20px";
            SFX.play('golden');
            setTimeout(() => { toast.style.bottom = "-100px"; }, 3000);
            log(`ACHIEVEMENT: ${a.title}`);
            saveGame();
        }
        
        function checkAchievements() {
            ACHIEVEMENTS.forEach(a => {
                if (!a.manual && !state.achievements.includes(a.id)) {
                    if (a.check(state)) unlockAchievement(a);
                }
            });
        }

        function log(msg) {
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            els.log.prepend(d);
            if(els.log.children.length > 50) els.log.lastChild.remove();
        }

        // --- Boredom Zone ---
        
        function renderDistractions() {
            els.dist.innerHTML = '';
            els.deskLeft.querySelectorAll('div:not(:first-child)').forEach(el => el.remove()); 
            els.deskRight.querySelectorAll('div:not(:first-child)').forEach(el => el.remove());
            DISTRACTIONS.forEach((d, index) => {
                const mobEl = createDistCard(d, 'mob'); els.dist.appendChild(mobEl);
                const deskEl = createDistCard(d, 'desk');
                if (index % 2 === 0) els.deskLeft.appendChild(deskEl); else els.deskRight.appendChild(deskEl);
            });
        }
        function createDistCard(d, suffix) {
            const unlocked = state.unlocks[d.id];
            const div = document.createElement('div');
            let border = unlocked ? 'border-blue-400 text-blue-400' : 'border-gray-600 text-gray-600';
            div.className = `box flex flex-col items-center justify-center p-2 text-center ${border}`;
            div.id = `dist-btn-${d.id}-${suffix}`;
            
            // Initial content - updated by renderDistractionsUI
            div.innerHTML = `<div class="font-bold text-xs dist-name">...</div><div class="text-[10px] italic mb-1 dist-desc">...</div><button class="btn w-full text-[10px] p-1">...</button>`;
            
            if (unlocked) {
                div.onclick = () => { d.action(); SFX.play('click'); };
            } else {
                div.onclick = () => buyDist(d.id);
            }
            return div;
        }

        // --- Minigame Actions ---
        function changeBg() {
            document.body.style.backgroundColor = `hsl(${Math.random()*360}, 50%, 5%)`;
            const now = Date.now();
            bgClicks.push(now);
            bgClicks = bgClicks.filter(t => now - t < 60000);
            if(bgClicks.length >= 20) unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='indecisive'));
        }
        
        function toggleSubBox() {
            state.unlocks.sub_box = true; // Should already be true
            log("SUBSCRIPTION BOX ACTIVE. WAIT 10 MINS.");
            document.getElementById('activeMinigame').innerHTML = `<div class="p-2 text-center text-xs">SUB BOX RUNNING IN BACKGROUND...</div>`;
        }
        
        function activateNetflix() {
            state.unlocks.netflix = true;
            log("NETFLIX BLOCKER ACTIVE. NO IDLE TIMEOUT.");
        }

        function renderRock() {
            els.mini.innerHTML = `<div class="p-4 text-center"><div class="text-4xl mb-2">ðŸª¨</div><button onclick="feedRock()" class="btn text-xs">FEED (1 CLOCK)</button></div>`;
        }
        window.feedRock = function() {
            if (state.clocks >= 1) { state.clocks--; state.stats.rockFed = (state.stats.rockFed||0)+1; SFX.play('click'); log("ROCK FED."); }
        }

        function renderBubble() {
            els.mini.innerHTML = `<div class="p-2 text-center"><div id="bubbleGrid" class="grid grid-cols-8 gap-2 bg-gray-900 p-2"></div><button onclick="renderBubble()" class="btn text-xs mt-2">RESET</button></div>`;
            const grid = document.getElementById('bubbleGrid');
            for(let i=0; i<24; i++) {
                const b = document.createElement('div'); b.className = 'bubble';
                b.onclick = function() {
                    if(!this.classList.contains('popped')) {
                        this.classList.add('popped'); SFX.play('click');
                        state.stats.bubblesPopped=(state.stats.bubblesPopped||0)+1;
                    }
                }
                grid.appendChild(b);
            }
        }

        function renderChat() {
            els.mini.innerHTML = `<div class="p-2 h-40 flex flex-col"><div id="chatBox" class="flex-1 overflow-y-auto text-xs bg-gray-900 p-1"></div></div>`;
            const msgs = ["POG", "LUL", "F", "Lag", "SECRET_BUTTON", "Hello", "When update?", "Skip"];
            const addMsg = () => {
                if(!document.getElementById('chatBox')) return;
                const m = msgs[Math.floor(Math.random()*msgs.length)];
                const div = document.createElement('div');
                div.innerHTML = `User: ${m}`;
                if(m === "SECRET_BUTTON" && Math.random() < 0.05) {
                    div.innerHTML = `User: <button onclick="unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='wait_what'))" class="text-[9px] border px-1">CLICK ME</button>`;
                }
                const box = document.getElementById('chatBox');
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
                state.stats.chatMsgs=(state.stats.chatMsgs||0)+1;
                setTimeout(addMsg, 500);
            };
            addMsg();
        }

        function renderDraw() {
            els.mini.innerHTML = `<div class="p-2 text-center"><canvas id="drawCanvas" width="200" height="150" style="border:1px dashed #666;background:#111"></canvas><br><button onclick="clearDraw()" class="btn text-xs">CLEAR</button></div>`;
            initDraw();
        }
        function initDraw() {
            const c = document.getElementById('drawCanvas'); const ctx = c.getContext('2d');
            let p=false;
            c.onmousedown=()=>{p=true}; c.onmouseup=()=>{p=false;ctx.beginPath()};
            c.onmousemove=(e)=>{
                if(!p)return; const r=c.getBoundingClientRect();
                ctx.lineWidth=2; ctx.strokeStyle='#fff';
                ctx.lineTo(e.clientX-r.left,e.clientY-r.top); ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX-r.left,e.clientY-r.top);
            }
        }
        window.clearDraw=()=>{const c=document.getElementById('drawCanvas');c.getContext('2d').clearRect(0,0,c.width,c.height)};

        function renderUnsorter() {
            els.mini.innerHTML = `<div class="p-2 text-center"><canvas id="unsorterCanvas" width="250" height="200"></canvas><div class="text-xs">Wind: <span id="windTimer">30</span>s</div></div>`;
            const cvs = document.getElementById('unsorterCanvas'); const ctx = cvs.getContext('2d');
            let pixels = Array(50).fill().map(()=>({x:Math.random()*250,y:Math.random()*200,c:['red','blue'][Math.floor(Math.random()*2)]}));
            let wind=30;
            const t = setInterval(()=>{
                wind--; if(document.getElementById('windTimer')) document.getElementById('windTimer').innerText=wind;
                if(wind<=0) { wind=30; pixels.forEach(p=>{p.x=Math.random()*250;p.y=Math.random()*200}); }
                if(!document.getElementById('unsorterCanvas')) clearInterval(t);
            },1000);
            cvs.onclick=(e)=>{
                const r=cvs.getBoundingClientRect(); const mx=e.clientX-r.left; const my=e.clientY-r.top;
                SFX.play('click');
                pixels.forEach(p=>{if(Math.abs(p.x-mx)<20 && Math.abs(p.y-my)<20) { p.x=mx+(Math.random()*20-10); p.y=my+(Math.random()*20-10); }});
            };
            function anim(){
                if(!document.getElementById('unsorterCanvas')) return;
                ctx.fillStyle='#000'; ctx.fillRect(0,0,250,200);
                pixels.forEach(p=>{ctx.fillStyle=p.c;ctx.fillRect(p.x,p.y,4,4)});
                requestAnimationFrame(anim);
            }
            anim();
        }

        function renderTodo() {
            els.mini.innerHTML = `<div class="p-2"><div id="todoList" class="h-32 overflow-y-auto text-xs border border-gray-700 mb-2"></div><button onclick="addTodoItem('New Task')" class="btn text-xs w-full">ADD TASK</button></div>`;
            addTodoItem("Sort Air");
        }
        window.addTodoItem = function(t) {
            const d = document.createElement('div'); d.className='todo-item';
            d.innerHTML = `<div class="w-3 h-3 border border-gray-500"></div><span>${t}</span>`;
            d.onclick = function() { this.remove(); SFX.play('click'); setTimeout(()=>addTodoItem("Regret"),200); setTimeout(()=>addTodoItem("Despair"),200); };
            document.getElementById('todoList').appendChild(d);
        }

        function renderWaiting() {
            els.mini.innerHTML = `<div class="p-4 text-center"><div class="text-6xl font-mono" id="waitNum">999</div><div class="text-xs">Waiting...</div></div>`;
            let n = 999;
            const i = setInterval(()=>{
                if(!document.getElementById('waitNum')) { clearInterval(i); return; }
                n--; document.getElementById('waitNum').innerText=n;
                if(n<=0) { 
                    document.getElementById('waitNum').innerText="MISSED"; 
                    // Professional Waiter Achievement trigger (technically number called)
                    unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='waiter'));
                    n=999; 
                }
            },100);
        }

        function renderAlmost() {
            els.mini.innerHTML = `<div class="p-4"><div class="w-full h-8 border border-white p-1"><div id="loadBar" class="h-full bg-white w-0"></div></div><div id="loadPct" class="text-right text-xs">0%</div></div>`;
            let p=0;
            function step() {
                if(!document.getElementById('loadBar')) return;
                if(p<99) p++; else if(p<99.9) p+=0.01; else { 
                    SFX.play('error'); p=0; 
                    state.stats.almostFail=(state.stats.almostFail||0)+1; 
                    unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='the_one_percent'));
                    if(state.stats.almostFail >= 5) unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='anticlimax'));
                }
                document.getElementById('loadBar').style.width = p+"%";
                document.getElementById('loadPct').innerText = p.toFixed(1)+"%";
                setTimeout(step, p>99?2000:50);
            }
            step();
        }
        
        function renderDontClick() {
             els.mini.innerHTML = `<div class="p-8 text-center"><button onclick="dontClick()" class="w-32 h-32 rounded-full bg-red-600 font-bold text-white">DO NOT CLICK</button></div>`;
        }
        window.dontClick = function() {
            SFX.play('ding'); state.seconds=0; updateUI(0,1);
            unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='rebel'));
            log("RESET TO 0.");
        }

        // --- Visuals (DVD) ---
        function toggleDVD() {
            const cvs = els.cvs;
            if (getComputedStyle(cvs).opacity === '0') {
                cvs.style.opacity = 0.5; cvs.width = window.innerWidth; cvs.height = window.innerHeight;
                requestAnimationFrame(animateDVD);
            } else { cvs.style.opacity = 0; }
        }
        let dvd = { x: 50, y: 50, dx: 3, dy: 3, w: 100, h: 50 };
        function animateDVD() {
            if (getComputedStyle(els.cvs).opacity === '0') return;
            const ctx = els.cvs.getContext('2d');
            ctx.clearRect(0, 0, els.cvs.width, els.cvs.height);
            dvd.x += dvd.dx; dvd.y += dvd.dy;
            let hit = false;
            // Corners check for achievement
            const w = els.cvs.width; const h = els.cvs.height;
            if ((dvd.x<=5||dvd.x+dvd.w>=w-5) && (dvd.y<=5||dvd.y+dvd.h>=h-5)) {
                unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='long_dist'));
            }

            if (dvd.x + dvd.w > w || dvd.x < 0) dvd.dx *= -1;
            if (dvd.y + dvd.h > h || dvd.y < 0) dvd.dy *= -1;

            if (assets.dvd.complete && assets.dvd.naturalHeight > 0) ctx.drawImage(assets.dvd, dvd.x, dvd.y, dvd.w, dvd.h);
            else { 
                ctx.strokeStyle = 'white'; 
                ctx.lineWidth = 2;
                ctx.strokeRect(dvd.x, dvd.y, dvd.w, dvd.h); 
                ctx.fillStyle = 'white'; 
                ctx.font = '20px monospace';
                ctx.fillText("DVD", dvd.x + 30, dvd.y + 30); 
            }
            requestAnimationFrame(animateDVD);
        }

        function toggleMusic() { 
            // Placeholder: In a real environment, this would toggle the audio element
            musicPlaying = !musicPlaying;
            log(musicPlaying ? "MUSIC: ON" : "MUSIC: OFF");
        }

        function spawnGoldenSecond() {
            const el = document.createElement('div'); el.innerText = "+60s"; el.className = "golden-second";
            el.style.left = Math.random() * 80 + 10 + "%";
            
            const capture = () => {
                if (el.parentNode && !el.classList.contains('captured')) {
                    el.classList.add('captured'); el.innerText = "CAPTURED!";
                    state.seconds += 60; state.totalSecondsWasted += 60; state.runSecondsWasted += 60;
                    SFX.play('golden'); log("+60s");
                    // Spree logic
                    const now = Date.now();
                    goldenSpree.push(now);
                    goldenSpree = goldenSpree.filter(t => now - t < 60000);
                    if(goldenSpree.length >= 5) unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='heist'));
                    setTimeout(() => el.remove(), 500);
                }
            };
            el.onclick = capture;
            
            document.body.appendChild(el);
            if (state.shopCounts.engine > 0) setTimeout(() => { if (Math.random() < 0.5) capture(); }, 1000);
            setTimeout(() => {
                if(el.parentNode && !el.classList.contains('captured')) {
                    unlockAchievement(ACHIEVEMENTS.find(a => a.id === 'missed'));
                    el.remove();
                }
            }, 4000);
        }

        // --- Save/Load ---
        function saveGame() {
            state.lastSaveTime = Date.now();
            localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify(state));
        }
        function loadGame() {
            const raw = localStorage.getItem(CONFIG.SAVE_KEY);
            if (raw) {
                try {
                    const s = JSON.parse(raw);
                    state = { ...state, ...s, 
                        settings: {...state.settings, ...(s.settings||{})},
                        shopCounts: {...state.shopCounts, ...s.shopCounts},
                        skills: {...state.skills, ...s.skills},
                        stats: {...state.stats, ...s.stats},
                        unlocks: {...state.unlocks, ...s.unlocks},
                        timers: {...state.timers, ...s.timers}
                    };
                    const now = Date.now();
                    const diffMins = Math.floor((now - (state.lastSaveTime || now)) / 60000);
                    if(diffMins > 2880) unlockAchievement(ACHIEVEMENTS.find(a=>a.id==='productive')); // 48h
                    if (diffMins > 0) {
                        const ups = Object.values(state.shopCounts).reduce((a,b)=>a+b,0);
                        let rate = CONFIG.OFFLINE_RATE + (ups * 0.5);
                        if (state.skills.deep_focus) rate *= 2;
                        const gain = Math.floor(diffMins * rate);
                        state.seconds += gain; state.totalSecondsWasted += gain; state.runSecondsWasted += gain;
                        els.offline.classList.remove('hidden');
                        document.getElementById('offlineGain').innerText = formatNum(gain);
                    }
                    if(state.settings.hardMode) document.body.classList.add('hard-mode-active');
                    if(state.settings.comicSans) document.body.classList.add('comic-sans');
                } catch(e) { console.error(e); }
            }
            renderShopUI();
            renderDistractions();
        }

        window.onload = function() {
            loadGame();
            document.getElementById('startOverlay').onclick = function() {
                if(ctxAudio.state === 'suspended') ctxAudio.resume();
                this.remove(); 
                requestAnimationFrame(gameLoop);
            };
            window.onresize = () => { els.cvs.width = window.innerWidth; els.cvs.height = window.innerHeight; };
            window.onmousemove = () => { state.timers.lastInput = Date.now(); };
        };
    </script>
</body>
</html>
